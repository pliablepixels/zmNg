name: Create Release

on:
  push:
    tags:
      - 'zmNg-*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous release tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -n1)
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" == "$CURRENT_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"
          echo "Current tag: $CURRENT_TAG"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ github.ref_name }}"

          CHANGELOG="## ðŸ“‹ Changelog\n\n"

          # Categorize commits
          FEATURES=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^feat" --regexp-ignore-case 2>/dev/null || echo "")
          FIXES=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^fix" --regexp-ignore-case 2>/dev/null || echo "")
          DOCS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^docs" --grep="^docfix" --regexp-ignore-case 2>/dev/null || echo "")
          TESTS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^test" --regexp-ignore-case 2>/dev/null || echo "")
          CHORES=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^chore" --regexp-ignore-case 2>/dev/null || echo "")
          REFACTORS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^refactor" --regexp-ignore-case 2>/dev/null || echo "")

          # Build changelog sections
          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}### âœ¨ Features\n${FEATURES}\n\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}### ðŸ› Bug Fixes\n${FIXES}\n\n"
          fi

          if [ -n "$DOCS" ]; then
            CHANGELOG="${CHANGELOG}### ðŸ“š Documentation\n${DOCS}\n\n"
          fi

          if [ -n "$TESTS" ]; then
            CHANGELOG="${CHANGELOG}### âœ… Tests\n${TESTS}\n\n"
          fi

          if [ -n "$REFACTORS" ]; then
            CHANGELOG="${CHANGELOG}### â™»ï¸ Code Refactoring\n${REFACTORS}\n\n"
          fi

          if [ -n "$CHORES" ]; then
            CHANGELOG="${CHANGELOG}### ðŸ”§ Chores\n${CHORES}\n\n"
          fi

          # Get other commits
          OTHER=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --invert-grep \
            --grep="^feat" --grep="^fix" --grep="^docs" --grep="^test" --grep="^chore" --grep="^refactor" \
            --regexp-ignore-case 2>/dev/null || echo "")

          if [ -n "$OTHER" ]; then
            CHANGELOG="${CHANGELOG}### ðŸ“ Other Changes\n${OTHER}\n\n"
          fi

          # Add link to detailed changelog
          CHANGELOG="${CHANGELOG}\n**[View detailed changelog](https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG})**\n\n"

          # Add separator
          CHANGELOG="${CHANGELOG}---\n\n"

          # Save to file for release
          echo -e "$CHANGELOG" > /tmp/changelog.md
          cat .github/workflows/_RELEASE_NOTE_INSERT.md >> /tmp/changelog.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_TAG="${{ github.ref_name }}"

          # Check if release already exists
          if gh release view "$CURRENT_TAG" >/dev/null 2>&1; then
            echo "Release $CURRENT_TAG already exists, updating notes"
            gh release edit "$CURRENT_TAG" --notes-file /tmp/changelog.md
          else
            echo "Creating release $CURRENT_TAG"
            gh release create "$CURRENT_TAG" \
              --title "$CURRENT_TAG" \
              --notes-file /tmp/changelog.md \
              --draft=false \
              --prerelease=false
          fi

          echo "âœ… Release $CURRENT_TAG created with changelog"
