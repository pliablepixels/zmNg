name: Generate Release Notes

on:
  release:
    types: [created]

jobs:
  generate-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g conventional-changelog-cli

      - name: Get previous release tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -n1)
          if [ -z "$PREV_TAG" ]; then
            # If no previous tag, get first commit
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ github.event.release.tag_name }}"

          # Generate changelog between tags
          CHANGELOG=$(conventional-changelog -p angular -r 0 --commit-path . 2>/dev/null || echo "")

          # If conventional-changelog fails, generate from git log
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="## Changes\n\n"

            # Categorize commits
            FEATURES=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^feat" --grep="^feature" --regexp-ignore-case)
            FIXES=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^fix" --regexp-ignore-case)
            DOCS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^docs" --grep="^docfix" --regexp-ignore-case)
            TESTS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^test" --regexp-ignore-case)
            CHORES=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^chore" --regexp-ignore-case)
            REFACTORS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --grep="^refactor" --regexp-ignore-case)

            # Build changelog
            if [ -n "$FEATURES" ]; then
              CHANGELOG="${CHANGELOG}### Features\n\n${FEATURES}\n\n"
            fi

            if [ -n "$FIXES" ]; then
              CHANGELOG="${CHANGELOG}### Bug Fixes\n\n${FIXES}\n\n"
            fi

            if [ -n "$DOCS" ]; then
              CHANGELOG="${CHANGELOG}### Documentation\n\n${DOCS}\n\n"
            fi

            if [ -n "$TESTS" ]; then
              CHANGELOG="${CHANGELOG}### Tests\n\n${TESTS}\n\n"
            fi

            if [ -n "$REFACTORS" ]; then
              CHANGELOG="${CHANGELOG}### Code Refactoring\n\n${REFACTORS}\n\n"
            fi

            if [ -n "$CHORES" ]; then
              CHANGELOG="${CHANGELOG}### Chores\n\n${CHORES}\n\n"
            fi

            # Get other commits not matching the above patterns
            OTHER=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --invert-grep --grep="^feat" --grep="^fix" --grep="^docs" --grep="^test" --grep="^chore" --grep="^refactor" --regexp-ignore-case)
            if [ -n "$OTHER" ]; then
              CHANGELOG="${CHANGELOG}### Other Changes\n\n${OTHER}\n\n"
            fi
          fi

          # Save to file
          echo -e "$CHANGELOG" > changelog.md

          # Also set as output (escape for GitHub Actions)
          {
            echo 'changelog<<EOF'
            echo -e "$CHANGELOG"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Update release notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          CHANGELOG="${{ steps.changelog.outputs.changelog }}"
          EXISTING_BODY="${{ github.event.release.body }}"

          # Combine existing body with changelog
          if [ -n "$EXISTING_BODY" ]; then
            NEW_BODY="${CHANGELOG}\n\n---\n\n${EXISTING_BODY}"
          else
            NEW_BODY="$CHANGELOG"
          fi

          # Update release
          gh release edit "$CURRENT_TAG" --notes "$NEW_BODY"
